import{d as t,g as e,c as l,f as s,e as n,r as i}from"./types.69209817.js";import{S as a}from"./SvgIcon.85a6de8b.js";import{_ as r}from"./UnitComponent.fa4ae866.js";import{d as o,v as c,x as u,u as p,G as _,r as m,o as d,c as y,a as h,F as f,j as v,n as g,H as k,k as C,b}from"./vendor.a60aa299.js";var w={map:"_map_ktb84_1",units:"_units_ktb84_8",select:"_select_ktb84_8",grid:"_grid_ktb84_16",cell:"_cell_ktb84_23",cellDark:"_cellDark_ktb84_29",cellType:"_cellType_ktb84_34",selType:"_selType_ktb84_41",cell_Base:"_cell_Base_ktb84_51",cell_Runes:"_cell_Runes_ktb84_55",cell_Target:"_cell_Target_ktb84_59",unitCtn:"_unitCtn_ktb84_63"};function T(t){const e=new Set;let l,s=M();const n=Array.isArray(t)?e=>t.indexOf(e.animationName)>-1:e=>e.animationName===t;function i(t){if(n(t)){const l=t.target,n=M()-s;l.style.setProperty("animation-delay",-n+"ms"),e.add(l)}}function a(t){n(t)&&(e.add(t.target),requestAnimationFrame((t=>{t!==l&&(s=M(),function(t){const e=[];t.forEach((l=>{if("paused"!==window.getComputedStyle(l).animationPlayState&&U(t,l)){const{animationName:t}=window.getComputedStyle(l);l.style.setProperty("animation-name",`${t}__sync`),e.push(l)}})),requestAnimationFrame((()=>{e.forEach((t=>{t.style.removeProperty("animation-name")}))}))}(e)),l=t})))}return window.addEventListener("animationstart",i,!0),window.addEventListener("animationiteration",a,!0),{getElements:()=>e,free(){window.removeEventListener("animationstart",i),window.removeEventListener("animationiteration",a),this.start(),e.clear()},start(){e.forEach((t=>{U(e,t)&&t.style.removeProperty("animation")}))},stop(){e.forEach((t=>{U(e,t)&&t.style.setProperty("animation","none")}))},pause(){e.forEach((t=>{U(e,t)&&t.style.setProperty("animation-play-state","paused")}))}}}function M(){return(new Date).getTime()}function U(t,e){const l=document.body.contains(e);return l||t.delete(e),l}var S=o({components:{UnitComponent:r,SvgIcon:a},data:()=>({sty:w}),props:{renderMap:{type:Object,required:!0}},methods:{directionToDeg:t},setup(t){let n=null;c((()=>{n=T([w.unitAnimation,w.unitDirectionAnimation])})),u((()=>{null==n||n.free()}));const i=p(new Map);let a=p(null);return{map:_(t,"renderMap"),setCellRef:(t,e)=>{i.value.set(t,e)},gridRef:a,cellsRefs:i,setGridRef:t=>{a.value=t},layerPositionStyle:t=>{const e=i.value.get(t);if(!e||!a.value)throw new Error("Impossible error");const l=a.value.offsetWidth/100,s=a.value.offsetHeight/100;return`\n\t\t\t\tleft: ${e.offsetLeft/l}%;\n\t\t\t\ttop: ${e.offsetTop/s}%;\n\t\t\t\twidth: ${e.clientWidth/l}%;\n\t\t\t\theight: ${e.clientHeight/s}%;\n\t\t\t`},cellClass:t=>t?w["cell_"+e[t.type]]:null,unitTypeClass:t=>w["unitSkinType_"+l[t.type]],selClass:t=>[w.selType,w["selType_"+s[t]]],cell:e=>{var l,s;const n=null==(l=t.renderMap.gameMap)?void 0:l.size.x,i=(e-1)%n,a=(e-1)/n|0;return null==(s=t.renderMap.gameMap)?void 0:s.getCell(i,a)},chessCell(e){var l;const s=null==(l=t.renderMap.gameMap)?void 0:l.size.x,n=(e-1)%s,i=(e-1)/s|0;return n%2==0&&i%2==0||n%2!=0&&i%2!=0}}}});var R={map:"_map_ktb84_1",units:"_units_ktb84_8",select:"_select_ktb84_8",grid:"_grid_ktb84_16",cell:"_cell_ktb84_23",cellDark:"_cellDark_ktb84_29",cellType:"_cellType_ktb84_34",selType:"_selType_ktb84_41",cell_Base:"_cell_Base_ktb84_51",cell_Runes:"_cell_Runes_ktb84_55",cell_Target:"_cell_Target_ktb84_59",unitCtn:"_unitCtn_ktb84_63"};const E=["onClick"];(S.__cssModules={})._sty=R,S.render=function(t,e,l,s,n,i){var a,r,o,c,u;const p=m("UnitComponent");return t.map.gameMap?(d(),y("div",{key:0,class:g(t.sty.map)},[h("div",{class:g(t.sty.grid),style:k(`grid-template-columns: repeat(${null==(a=t.map.gameMap)?void 0:a.size.x}, 1fr);aspect-ratio: ${null==(r=t.map.gameMap)?void 0:r.size.x}/${null==(o=t.map.gameMap)?void 0:o.size.y};`),ref:t.setGridRef},[(d(!0),y(f,null,v((null==(c=t.map.gameMap)?void 0:c.size.x)*(null==(u=t.map.gameMap)?void 0:u.size.y),(e=>(d(),y("div",{ref:l=>t.setCellRef(t.cell(e),l),class:g([t.sty.cell,{[t.sty.cellDark]:t.chessCell(e)}])},[h("div",{class:g([t.sty.cellType,t.cellClass(t.cell(e))])},null,2)],2)))),256))],6),t.gridRef&&t.cellsRefs.size?(d(),y("div",{key:0,class:g(t.sty.units)},[(d(!0),y(f,null,v(t.map.units,(([e,{cell:l,key:s,state:n,skin:i}])=>(d(),y("div",{style:k(t.layerPositionStyle(l)+`transition: left ${t.map.moveUnitMs||500}ms, top ${t.map.moveUnitMs||500}ms;`),key:s,class:g(t.sty.unitCtn)},[b(p,{skin:i,state:n,direction:t.map.cellsDirection.has(e)?t.map.cellsDirection.get(e):void 0},null,8,["skin","state","direction"])],6)))),128))],2)):C("",!0),t.map.cellsToSelect.size?(d(),y("div",{key:1,class:g(t.sty.select)},[(d(!0),y(f,null,v(t.map.cellsToSelect,(([e,{highlight:l}])=>(d(),y("button",{type:"button",style:k(t.layerPositionStyle(e)),class:g(t.selClass(l)),onClick:l=>{var s,n;return null==(n=null==(s=t.map)?void 0:s.onCellClick)?void 0:n.call(s,e)}},null,14,E)))),256))],2)):C("",!0)],2)):C("",!0)};class x{constructor(t,e,l){this.x=t,this.y=e,this.type=l,this._unit=null,this.stop=!1}set unit(t){if(null!==this._unit)throw"unit has been planted";this._unit=t}get unit(){return this._unit}killUnit(){this._unit=null}hasUnit(){return null!==this._unit}}class z{constructor(t){this.inputMap=t,this.map=[],this.typesCells=[],this.size={x:this.inputMap[0].length,y:this.inputMap.length};for(let l=0;l<e._length;l++)this.typesCells.push([]);for(let e=0;e<t.length;e++){this.map.push([]);for(let l=0;l<t[e].length;l++){let s=new x(l,e,t[e][l]);this.map[e][l]=s,this.typesCells[s.type].push(s)}}}getCell(t,e){var l,s,n;return null!=(n=null==(s=null==(l=this.map)?void 0:l[e])?void 0:s[t])?n:null}getAllCellsByType(t){return this.typesCells[t]}getAllCellHasUnits(t){var e;let l=[];for(let s of this.map)for(let n of s)n.hasUnit()&&(null==(e=null==n?void 0:n.unit)?void 0:e.type)===t&&l.push(n);return l}moveUnitFromCellToCoords(t,e,l){let s=this.getCell(e,l);return null===s||s.hasUnit()?null:(s.unit=t.unit,t.killUnit(),s)}}class D{constructor(t){this.type=t,this.direction=n._90,this._attachedCell=null}set ownerUser(t){this._ownerUser=t}get ownerUser(){return this._ownerUser}set attachedCell(t){this._attachedCell=t}get attachedCell(){return this._attachedCell}rotate(t){this.direction=i(this.direction,t)}}export{z as G,D as U,S as _};
